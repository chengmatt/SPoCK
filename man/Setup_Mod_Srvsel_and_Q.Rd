% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/Setup_Survey.R
\name{Setup_Mod_Srvsel_and_Q}
\alias{Setup_Mod_Srvsel_and_Q}
\title{Setup survey selectivity and catchability specifications}
\usage{
Setup_Mod_Srvsel_and_Q(
  input_list,
  cont_tv_srv_sel,
  srv_sel_blocks,
  srv_sel_model,
  Use_srv_q_prior = 0,
  srv_q_prior = NA,
  srv_q_blocks,
  srvsel_pe_pars_spec = NULL,
  srv_fixed_sel_pars_spec,
  srv_q_spec = NULL,
  srv_sel_devs_spec = NULL,
  corr_opt_semipar = NULL,
  srv_q_formula = NULL,
  srv_q_cov_dat = NULL,
  ...
)
}
\arguments{
\item{input_list}{List containing a data list, parameter list, and map list}

\item{cont_tv_srv_sel}{Character vector specifying the form of continuous time-varying selectivity for each survey fleet.
The vector must be length \code{n_srv_fleets}, and each element must follow the structure:
\code{"<time variation type>_Fleet_<fleet number>"}.

Valid time variation types include:
\itemize{
  \item \code{"none"}: No continuous time variation.
  \item \code{"iid"}: Independent and identically distributed deviations across years.
  \item \code{"rw"}: Random walk in time.
  \item \code{"3dmarg"}: 3D marginal time-varying selectivity.
  \item \code{"3dcond"}: 3D conditional time-varying selectivity.
  \item \code{"2dar1"}: Two-dimensional AR1 process.
}

For example:
\itemize{
  \item \code{"iid_Fleet_1"} applies an iid time-varying structure to Fleet 1.
  \item \code{"none_Fleet_2"} means no time variation is used for Fleet 2.
}

\strong{Note:} If time-block-based selectivity (via \code{srv_sel_blocks}) is specified for a fleet, then its corresponding entry here must be \code{"none_Fleet_<fleet number>"}.}

\item{srv_sel_blocks}{Character vector specifying the survey selectivity blocks for each region and fleet.
Each element must follow the structure: `"Block_<block number>_Year_<start>-<end>_Fleet_<fleet number>"` or `"none_Fleet_<fleet number>"`.
This allows users to define time-varying selectivity blocks for specific fleets within a region.

For example:
\itemize{
  \item \code{"Block_1_Year_1-35_Fleet_1"} defines selectivity block 1 for Fleet 1 covering years 1 through 35.
  \item \code{"Block_2_Year_36-56_Fleet_1"} defines block 2 for Fleet 1 for years 36 to 56.
  \item \code{"Block_3_Year_57-terminal_Fleet_1"} assigns block 3 from year 57 through the terminal year for Fleet 1.
  \item \code{"none_Fleet_2"} indicates that no survey selectivity blocks are used for Fleet 2.
}

The blocks must be non-overlapping and sequential in time within each fleet, and block numbers must be unique within each fleet.}

\item{srv_sel_model}{Character vector specifying the survey selectivity model for each fleet.
The vector must be length \code{n_srv_fleets}, and each element must follow the structure:
\code{"<selectivity model>_Fleet_<fleet number>"}.

Available selectivity model types include:
\itemize{
  \item \code{"logist1"}: Logistic function with parameters \code{a50} and \code{k}.
  \item \code{"logist2"}: Logistic function with parameters \code{a50} and \code{a95}.
  \item \code{"gamma"}: Dome-shaped gamma function with parameters \code{amax} and \code{delta}.
  \item \code{"exponential"}: Exponential function with a power parameter.
  \item \code{"dbnrml"}: Double normal function with 6 parameters.
}

For example:
\itemize{
  \item \code{"logist1_Fleet_1"} uses the logistic (a50, k) model for Fleet 1.
  \item \code{"gamma_Fleet_2"} uses the gamma dome-shaped model for Fleet 2.
}

The models are applied by region and year as defined in the overall model array structure
(\code{n_regions} x \code{n_years} x \code{n_srv_fleets}), though this vector defines only the functional form for each fleet.

For mathematical definitions and implementation details of each selectivity form, refer to the model equations vignette.}

\item{Use_srv_q_prior}{Integer specifying whether to use survey q prior or not (0 dont use) (1 use)}

\item{srv_q_prior}{Survey q priors in normal space, dimensioned by region, block,  survey fleet, and 2 (mean, and sd in the 4 dimension of array)}

\item{srv_q_blocks}{Character vector specifying survey catchability (q) blocks for each fleet.
Each element must follow the structure: \code{"Block_<block number>_Year_<start>-<end>_Fleet_<fleet number>"}
or \code{"none_Fleet_<fleet number>"}.

This allows users to define time-varying catchability blocks independently of selectivity blocks.
The blocks must be non-overlapping and sequential in time within each fleet.

For example:
\itemize{
  \item \code{"Block_1_Year_1-35_Fleet_1"} assigns block 1 to Fleet 1 for years 1–35.
  \item \code{"Block_2_Year_36-56_Fleet_1"} continues with block 2 for years 36–56.
  \item \code{"Block_3_Year_57-terminal_Fleet_1"} assigns block 3 from year 57 to the terminal year for Fleet 1.
  \item \code{"none_Fleet_2"} indicates no catchability blocks are used for Fleet 2.
}

Internally, these specifications are converted to a \code{[n_regions, n_years, n_srv_fleets]} array,
where each block is mapped to the appropriate years and fleets.}

\item{srvsel_pe_pars_spec}{Character string specifying how process error parameters for survey selectivity
are estimated across regions and sexes. This is only relevant if \code{cont_tv_srv_sel} is not set to \code{"none"};
otherwise, all process error parameters are treated as fixed.

Available options include:
\itemize{
  \item \code{"est_all"}: Estimates separate process error parameters for each region and sex.
  \item \code{"est_shared_r"}: Shares process error parameters across regions (sex-specific parameters are still estimated).
  \item \code{"est_shared_s"}: Shares process error parameters across sexes (region-specific parameters are still estimated).
  \item \code{"est_shared_r_s"}: Shares process error parameters across both regions and sexes, estimating a single set of parameters.
  \item \code{"fix"} or \code{"none"}: Does not estimate process error parameters; all are treated as fixed.
}}

\item{srv_fixed_sel_pars_spec}{Character string specifying the structure for estimating
fixed-effect parameters of the survey selectivity model (e.g., a50, k, amax).
This controls whether selectivity parameters are estimated separately or shared across regions and sexes.

Available options include:
\itemize{
  \item \code{"est_all"}: Estimates separate fixed-effect selectivity parameters for each region and sex.
  \item \code{"est_shared_r"}: Shares parameters across regions (sex-specific parameters are still estimated).
  \item \code{"est_shared_s"}: Shares parameters across sexes (region-specific parameters are still estimated).
  \item \code{"est_shared_r_s"}: Shares parameters across both regions and sexes, estimating a single set of fixed-effect parameters.
}}

\item{srv_q_spec}{Character string specifying the structure of survey catchability (\code{q}) estimation
across regions. This controls whether separate or shared parameters are used.

Available options include:
\itemize{
  \item \code{"est_all"}: Estimates separate catchability parameters for each region.
  \item \code{"est_shared_r"}: Estimates a single catchability parameter shared across all regions.
}}

\item{srv_sel_devs_spec}{Character string specifying the structure of process error deviations
in time-varying survey selectivity dimensioned by the number of survey fleets. This determines how deviations are estimated across regions and sexes.

Available options include:
\itemize{
  \item \code{"est_all"}: Estimates a separate deviation time series for each region and sex.
  \item \code{"est_shared_r"}: Shares deviations across regions (sex-specific deviations are still estimated).
  \item \code{"est_shared_s"}: Shares deviations across sexes (region-specific deviations are still estimated).
  \item \code{"est_shared_r_s"}: Shares deviations across both regions and sexes, estimating a single deviation time series.
}

This argument is only used when a continuous time-varying selectivity form is specified (e.g., via \code{cont_tv_srv_sel}).}

\item{corr_opt_semipar}{Character string specifying which correlation structures to suppress
  when using semi-parametric time-varying selectivity models. Only used if \code{cont_tv_sel}
  is set to one of \code{"3dmarg"}, \code{"3dcond"}, or \code{"2dar1"}.

  This option allows users to turn off estimation of specific correlation components in the
  time-varying selectivity model. This can improve stability or enforce assumptions about
  independence in the temporal or age structure.

  Available options:
  \itemize{
    \item \code{"corr_zero_y"}: Sets year (temporal) correlations to 0.
    \item \code{"corr_zero_a"}: Sets age correlations to 0.
    \item \code{"corr_zero_y_a"}: Sets both year and age correlations to 0.
    \item \code{"corr_zero_c"}: Sets cohort correlations to 0. Only valid for \code{cont_tv_sel} = \code{"3dmarg"} or \code{"3dcond"}.
    \item \code{"corr_zero_y_c"}: Sets year and cohort correlations to 0. Only valid for \code{cont_tv_sel} = \code{"3dmarg"} or \code{"3dcond"}.
    \item \code{"corr_zero_a_c"}: Sets age and cohort correlations to 0. Only valid for \code{cont_tv_sel} = \code{"3dmarg"} or \code{"3dcond"}.
    \item \code{"corr_zero_y_a_c"}: Sets all correlations (year, age, and cohort) to 0.
      Only valid for \code{cont_tv_sel} = \code{"3dmarg"} or \code{"3dcond"}; equivalent to an iid structure.
  }

These correlation-suppression flags are ignored when \code{cont_tv_sel} is set to any other value.}

\item{srv_q_formula}{A named list of formulas specifying environmental covariate relationships
for each region and survey fleet. Each element should be named using the convention
`"Region_<region>_Fleet_<fleet>"` and contain a formula object using covariate names present in
`srv_q_cov_dat`. The formula determines how environmental covariates influence survey catchability.
If `NULL`, no environmental covariate effects are included.}

\item{srv_q_cov_dat}{A named list containing time series vectors (typically by year) of environmental
covariates used in the `srv_q_formula`. Each entry should be a numeric vector of length equal to the
number of years, and names must match the variable names used in the formulas. If `NULL`, survey
catchability is assumed to be time-invariant (i.e., not influenced by environmental variables).}

\item{...}{Additional arguments specifying starting values for survey selectivity and catchability parameters (srvsel_pe_pars, ln_srvsel_devs, ln_srv_fixed_sel_pars, ln_srv_q, srv_q_coeff)}
}
\description{
Setup survey selectivity and catchability specifications
}
\details{
If both `srv_q_formula` and `srv_q_cov_dat` are non-`NULL`, the model constructs time-varying design matrices
for each region and fleet based on the provided formulas and environmental covariates. A coefficient array
(`srv_q_coeff`) and a mapping array (`map_srv_q_coeff`) are created to estimate and track the associated
regression coefficients. The design matrix is stored in `srv_q_env`, a 4D array indexed by
\code{[region, year, fleet, covariate]}.

If either argument is `NULL`, environmental covariate effects are excluded and survey catchability is treated
as constant over time.

\strong{Important:} All covariate time series in `srv_q_cov_dat` must:
\itemize{
  \item Be numeric vectors with a length equal to the number of years in the model.
  \item Align to the same years across all covariates.
  \item Contain no missing values; users must impute or interpolate missing covariate values prior to use. For years in which the index is not used, values can be set at 0.
}

Covariates that are defined but not used in any formula can be filled with zeros (e.g., \code{rep(0, n_yrs)}).
This avoids issues with list structure but does not affect the design matrix or model results.

\strong{Example formulas:}
\itemize{
  \item \code{"Region_1_Fleet_1"} = \code{~ 0 + poly(env1_r1_f1, 3) + env2_r1_f1} uses a 3rd-degree
        polynomial for \code{env1_r1_f1} and a linear term for \code{env2_r1_f1}.
  \item \code{"Region_2_Fleet_1"} = \code{~ 0 + env1_r2_f1 + env2_r2_f1} includes additive effects of
        two covariates.
  \item \code{"Region_3_Fleet_2"} = \code{~ NULL} disables environmental covariates for that fleet-region.
}
}
